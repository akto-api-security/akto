import { useEffect, useRef, useState } from 'react';
import { useParams } from 'react-router-dom';
import PersistStore from '@/apps/main/PersistStore';
import api from '../api';
import issuesApi from '@/apps/dashboard/pages/issues/api';
import GithubSimpleTable from "@/apps/dashboard/components/tables/GithubSimpleTable";
import SpinnerCentered from "@/apps/dashboard/components/progress/SpinnerCentered";
import { CellType } from "@/apps/dashboard/components/tables/rows/GithubRow"
import { Avatar, Badge, Box, Button, DataTable, Divider, Frame, HorizontalGrid, HorizontalStack, Link, Text, TopBar, VerticalStack } from '@shopify/polaris';
import './styles.css'
import func from "@/util/func";
import html2pdf from 'html2pdf.js';
import IssuesGraph from './IssuesGraph';
import ReportSummaryInfoCard from './ReportSummaryInfoCard';
import Category from './Category';

function VulnerabilityReport() {
    const pdfRef = useRef();

    const params = useParams();
    const testingRunSummaryId = params.summaryId
    const issuesFilter = params.issuesFilter

    const [loading, setLoading] = useState(true)
    const [enableDownload, setEnableDownload] = useState(false)

    const [vulnerableResultsMap, setVulnerableResultsMap] = useState([]);
    const [severitiesCount, setSeveritiesCount] = useState({ HIGH: 0, MEDIUM: 0, LOW: 0 });
    const [categoryVsIssuesMap, setCategoryVsIssuesMap] = useState({})
    const [categoryVsApisCountMap, setCategoryVsApisCountMap] = useState({})
    const [aktoFindingsTableData, setAktoFindingsTableData] = useState([])

    const collectionsMap = PersistStore(state => state.collectionsMap)
    const subCategoryMap = PersistStore(state => state.subCategoryMap)
    const categoryMap = PersistStore(state => state.categoryMap)

    const organizationName = func.capitalizeFirstLetter(window.ACCOUNT_NAME || "")

    const createVulnerabilityMap = (testingRunResults) => {
        let categoryVsIssuesMap = {}
        let categoryVsApisCountMap = {}
        let issueVsVulMap = {}
        let aktoFindingsTableData = []
        let high = 0
        let medium = 0
        let low = 0
        testingRunResults?.length > 0 && testingRunResults.forEach((testingRun) => {
            let testSubtype = testingRun?.testSubType
            let testInfo = subCategoryMap?.[testSubtype]

            if (!testInfo) {
                return
            }
            let severity = testInfo?.superCategory?.severity?._name
            let severityIndex = 0;
            switch (severity) {
                case 'HIGH':
                    ++high
                    severityIndex = 2
                    break;
                case 'MEDIUM':
                    ++medium
                    severityIndex = 1
                    break;
                case 'LOW':
                    ++low
                    severityIndex = 0
                    break;
                default:
                    break;
            }

            let vulnerabilities = issueVsVulMap[testSubtype]
            if (vulnerabilities === undefined) {
                vulnerabilities = JSON.parse(JSON.stringify(testInfo))
            }
            let vulnerableTestingRunResults = vulnerabilities["vulnerableTestingRunResults"]
            if (vulnerableTestingRunResults === undefined) {
                vulnerableTestingRunResults = []
            }
            vulnerableTestingRunResults.push(testingRun)
            vulnerabilities['vulnerableTestingRunResults'] = vulnerableTestingRunResults
            vulnerabilities['severityIndex'] = severityIndex
            issueVsVulMap[testSubtype] = vulnerabilities
        })
        setSeveritiesCount({ HIGH: high, MEDIUM: medium, LOW: low });

        let localCopy = vulnerableResultsMap
        Object.keys(issueVsVulMap).forEach((testSubtype) => {
            let obj = issueVsVulMap[testSubtype]
            localCopy.push({ category: obj })
        })

        for (const [testSubType, issue] of Object.entries(issueVsVulMap)) {
            const categoryName = issue.superCategory.name

            if (!categoryName) {
                continue
            }

            let issuesList
            if (!categoryVsIssuesMap.hasOwnProperty(categoryName)) {
                issuesList = []
                categoryVsIssuesMap[categoryName] = issuesList
            } else {
                issuesList = categoryVsIssuesMap[categoryName]
            }

            issuesList.push(issue)

            let apisCount = 0
            if (!categoryVsApisCountMap.hasOwnProperty(categoryName)) {
                categoryVsApisCountMap[categoryName] = 0
            } else {
                apisCount = categoryVsApisCountMap[categoryName]
            }

            apisCount += issue.vulnerableTestingRunResults.length
            categoryVsApisCountMap[categoryName] = apisCount
        }

        Object.keys(categoryVsIssuesMap).forEach((categoryName, index) => {
            const categoryDetails = categoryMap[categoryName]

            aktoFindingsTableData.push({
                sno: index + 1,
                categoryDisplayName: categoryDetails.displayName,
                categoryDisplayNameComp: (
                    <Link onClick={(e) => e.stopPropagation()} url={`#${categoryName}`} removeUnderline>
                        <Text variant='bodyMd' color='subdued'>
                            {categoryDetails.displayName}
                        </Text>
                    </Link>
                ),
                apisAffected: categoryVsApisCountMap[categoryName],
                categorySeverity: categoryDetails.severity._name,
                categorySeverityComp: <Badge size="small" status={func.getTestResultStatus(categoryDetails.severity._name)}>{categoryDetails.severity._name}</Badge>
            })
        })

        setCategoryVsIssuesMap(categoryVsIssuesMap)
        setCategoryVsApisCountMap(categoryVsApisCountMap)
        setVulnerableResultsMap(localCopy)
        setAktoFindingsTableData(aktoFindingsTableData)
    }

    const fetchVulnerableData = async () => {
        let resultsCount = 0;
        let vulnerableTestingRunResults = []
        //let sampleDataVsCurlMap = {}

        if (testingRunSummaryId) {
            while (true) {
                let testingRunCountsFromDB = 0
                await api.fetchVulnerableTestingRunResults(testingRunSummaryId, resultsCount).then((resp) => {
                    vulnerableTestingRunResults = [...vulnerableTestingRunResults, ...resp.testingRunResults]
                    testingRunCountsFromDB = resp.testingRunResults.length
                    //sampleDataVsCurlMap = { ...sampleDataVsCurlMap, ...resp.sampleDataVsCurlMap }
                })
                resultsCount += 50
                if (testingRunCountsFromDB < 50) {
                    //EOF: break as no further documents exists
                    break
                }
            }
        } else if (issuesFilter) {
            while (true) {
                let testingRunCountsFromDB = 0
                let filters = JSON.parse(atob(issuesFilter))
                await issuesApi.fetchVulnerableTestingRunResultsFromIssues(filters, resultsCount).then(resp => {
                    vulnerableTestingRunResults = [...vulnerableTestingRunResults, ...resp.testingRunResults]
                    testingRunCountsFromDB = resp.totalIssuesCount
                    //sampleDataVsCurlMap = { ...sampleDataVsCurlMap, ...resp.sampleDataVsCurlMap }
                })
                resultsCount += 50
                if (testingRunCountsFromDB < 50 || resultsCount >= 1000) {
                    //EOF: break as no further documents exists
                    break
                }
            }
        }
        //setDataToCurlObj(sampleDataVsCurlMap)
        createVulnerabilityMap(vulnerableTestingRunResults)
    }

    useEffect(() => {
        setLoading(true)
        setEnableDownload(false)
        fetchVulnerableData()
        setLoading(false)
        setEnableDownload(true)
    }, [])

    function getDaySuffix(day) {
        if (day > 3 && day < 21) return 'th';
        switch (day % 10) {
            case 1: return 'st';
            case 2: return 'nd';
            case 3: return 'rd';
            default: return 'th';
        }
    }
    function formatDate(date) {
        const day = date.getDate();
        const month = date.toLocaleString('default', { month: 'long' });
        const year = date.getFullYear();
        const daySuffix = getDaySuffix(day);
        return `${day}${daySuffix} ${month}, ${year}`;
    }

    const currentDate = formatDate(new Date());
    const handleDownloadPDF = () => {
        setEnableDownload(false)
        func.setToast(true, false, "Donwloading API security findings")

        // Clone the element
        const originalElement = pdfRef.current;
        const clonedElement = originalElement.cloneNode(true);
        clonedElement.style.margin = 'auto';

        const headerContainer = document.createElement('div');
        headerContainer.innerHTML = `
            <div class="report-header-css" style="margin-top: 10px">
                <div style="width: 100%">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>${organizationName} API Security Findings</h4>
                            <p>${currentDate}</p>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <img src='/public/white_logo.svg' alt="Logo" class='top-bar-logo' />
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Find all div elements with the class name html2pdf__page-break
        const pageBreaks = clonedElement.querySelectorAll('.html2pdf__page-break');

        // Insert the headerContainer after each page break
        pageBreaks.forEach(pageBreak => {
            const headerClone = headerContainer.cloneNode(true);
            pageBreak.parentNode.insertBefore(headerClone, pageBreak.nextSibling);
        });

        // Append the cloned element to the body
        document.body.appendChild(clonedElement);

        const opt = {
            margin: 0.5,
            filename: 'akto_security_findings.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: "in", format: 'letter', orientation: 'portrait' },
            enableLinks: false,
        };

        html2pdf().set(opt).from(clonedElement).save().then(() => {
            // Remove the cloned element after PDF generation
            document.body.removeChild(clonedElement);
            setEnableDownload(true)
        });

    }
    const reportSecondaryMenu = (
        <div className="report-header-css header-css" id="report-secondary-menu-container">
            <Box width="100%">
                <HorizontalStack align="space-between">
                    <VerticalStack>
                        <Text variant="headingXs">{organizationName} API Security Findings</Text>
                        <Text variant="bodySm">{currentDate}</Text>
                    </VerticalStack>
                    <div style={{ display: 'flex', alignItems: 'center' }}>
                        <Button primary onClick={() => handleDownloadPDF()} disabled={!enableDownload}>Download</Button>
                        <img src='/public/white_logo.svg' alt="Logo" className='top-bar-logo' />
                    </div>
                </HorizontalStack>
            </Box>
        </div>
    )

    // Table of contents
    const aktoFindingsChildren = []
    Object.keys(categoryVsIssuesMap).forEach((categoryName, index) => {
        const categoryDetails = categoryMap[categoryName]
        aktoFindingsChildren.push({
            text: categoryDetails.displayName,
            link: categoryName,
            children: null,
        })
    })
    const tocList = [
        { text: "Report summary", link: "report-summary", children: null },
        { text: "Akto findings", link: "findings-table", children: aktoFindingsChildren },
        { text: "Our Approach: Scanning using Swagger file vs Real traffic data", link: "approach-container", children: null }
    ]

    // Akto findings table
    const aktoFindingsTableResourceName = {
        singular: 'Akto finding',
        plural: 'Akto findings',
    };

    const aktoFindingsTableHeaders = [
        {
            title: "S.No.",
            value: "sno",
            type: CellType.TEXT
        },
        {
            title: "Issue catgory",
            value: "categoryDisplayNameComp",
            textValue: "categoryDisplayName",
        },
        {
            title: "APIs affcted",
            value: "apisAffected",
            type: CellType.TEXT
        },
        {
            title: "Severity",
            value: "categorySeverity",
            type: CellType.TEXT
        }
    ]

    const reportTopBar = (
        <TopBar secondaryMenu={reportSecondaryMenu} />
    )

    // Report summary
    let totalIssues = 0, apisAffected = 0
    Object.values(categoryVsIssuesMap).forEach(categoryIssuesList => {
        totalIssues += categoryIssuesList.length
    })
    Object.values(categoryVsApisCountMap).forEach(apisCount => {
        apisAffected += apisCount
    })

    const reportSummaryItems = [
        {
            title: "Total issues",
            data: totalIssues,
        },
        {
            title: "Severity",
            data: (
                <Box>
                    <HorizontalGrid columns={3} gap={1}>
                        <Box key="high" borderInlineEndWidth={1} paddingBlockStart={1} paddingBlockEnd={1} borderColor="border-subdued">
                            <div style={{ color: "#D72C0D" }}>
                                <Text variant="headingLg">{severitiesCount?.HIGH} High</Text>
                            </div>
                        </Box>
                        <Box key="medium" borderInlineEndWidth={1} paddingBlockStart={1} paddingBlockEnd={1} borderColor="border-subdued">
                            <div style={{ color: "#916A00" }}>
                                <Text variant="headingLg">{severitiesCount?.MEDIUM} Medium</Text>
                            </div>
                        </Box>
                        <Box key="low" borderInlineEndWidth={0} paddingBlockStart={1} paddingBlockEnd={1} borderColor="border-subdued">
                            <div style={{ color: "#2C6ECB" }}>
                                <Text variant="headingLg">{severitiesCount?.LOW} Low</Text>
                            </div>
                        </Box>
                    </HorizontalGrid>
                </Box>


            ),
            isComp: true
        },
        {
            title: "APIs affected",
            data: apisAffected
        }
    ]

    // Approach
    const approachItems = [
        {
            title: "Enhanced Endpoint Coverage",
            content: "Even though Swagger files include several endpoints, only a small portion are directly testable. The majority require specific data elements like identifiers for testing. By utilizing real traffic data, we can significantly increase our endpoint coverage."
        },
        {
            title: "Expanded Test Scope",
            content: "Real traffic data allowed us to test for more sophisticated issues such as Business Logic flaws, Broken Authentication, and Broken Authorization, which isn't possible with the Swagger file alone."
        },
        {
            title: "Detection of Shadow APIs",
            content: "Our approach reveals several APIs that aren't documented in the Swagger file, highlighting the presence of Shadow APIs."
        }
    ]

    return (
        <div>
            <Frame topBar={reportTopBar}>
                {loading === false ?
                    (<div ref={pdfRef} id="report-container">
                        <Box background="bg">
                            <div className='report-cover-page-container'>
                                <img src='/public/vulnerability_header.png' alt="Header Image" className='report-cover-page' />
                                <img src='/public/white_logo.svg' alt='akt-logo' className='report-akto-logo'></img>
                                <div className='report-cover-page-content'>
                                    <Box width="100%">
                                        <HorizontalStack align="space-between">
                                            <VerticalStack gap={'5'}>
                                                <Text variant="bodyLg">Vulnerability Report</Text>
                                                <div className="heading-text">
                                                    <Text variant="heading4xl">{organizationName} API Security Findings</Text>
                                                </div>
                                                <Text variant="bodyMd">{currentDate}</Text>
                                            </VerticalStack>
                                        </HorizontalStack>
                                    </Box>
                                </div>
                            </div>

                            <div className="html2pdf__page-break"></div>
                            <div className="report-content-section">
                                <VerticalStack gap="3">
                                    <Text variant="headingLg">Table of contents</Text>
                                    <VerticalStack gap="2">
                                        {tocList.map((tocEntry, index) => {
                                            return (
                                                <div key={index} className='toc-entry-container'>
                                                    <Link key={index} url={`#${tocEntry.link}`} removeUnderline>
                                                        <Text variant='bodyMd' color='subdued'>
                                                            {index + 1}. {tocEntry.text}
                                                        </Text>
                                                    </Link>
    
                                                    <div className='toc-children-container'>
                                                        <VerticalStack gap="3">
                                                            {tocEntry.children && tocEntry.children.map((child, index) => {
                                                                return (
                                                                    <Link key={index} url={`#${child.link}`} removeUnderline>
                                                                        <Text variant='bodyMd' color='subdued'>
                                                                            {index + 1}. {child.text}
                                                                        </Text>
                                                                    </Link>
                                                                )
                                                            })}
                                                        </VerticalStack>
                                                    </div>
                                                </div>
                                            )
                                        })}
                                    </VerticalStack>
                                </VerticalStack>
                            </div>

                            <div className="report-content-section">
                                <VerticalStack gap="4">
                                    <Text variant="headingLg">1. Report summary</Text>
                                    <ReportSummaryInfoCard summaryItems={reportSummaryItems} />
                                    <IssuesGraph categoryIssues={categoryVsIssuesMap} />
                                </VerticalStack>
                            </div>
                            <Divider />
                            <div className="html2pdf__page-break"></div>

                            <div className="report-content-section">
                                <VerticalStack gap="3">
                                    <Text variant="headingLg">2. Akto findings</Text>
                                    <GithubSimpleTable
                                        key="table"
                                        data={aktoFindingsTableData}
                                        resourceName={aktoFindingsTableResourceName}
                                        headers={aktoFindingsTableHeaders}
                                        useNewRow={true}
                                        condensedHeight={true}
                                        hideQueryField={true}
                                        headings={aktoFindingsTableHeaders}
                                        hidePagination={true}
                                    />
                                </VerticalStack>
                            </div>
                            <Divider />

                            {Object.keys(categoryVsIssuesMap).length > 0 && Object.keys(categoryVsIssuesMap).map((categoryName, index) => {
                                return (
                                    <div>
                                        <Category
                                            key={index}
                                            index={index}
                                            categoryName={categoryName}
                                            categoryIssues={categoryVsIssuesMap[categoryName]}
                                            categoryMap={categoryMap}
                                            categoryVsApisCountMap={categoryVsApisCountMap}
                                        />
                                        {index !== categoryVsIssuesMap.length - 1 ? (
                                            <div>
                                                <Divider />
                                                <div className="html2pdf__page-break"></div>
                                            </div>
                                        ) : null}
                                    </div>
                                )
                            })}

                            <div className="report-content-section">
                                <Box>
                                    <VerticalStack gap="3">
                                        <Text variant="headingLg">3. Our Approach: Scanning using Swagger file vs Real traffic data</Text>
                                        <Text variant="bodyMd">
                                            Utilizing Akto's approach of using real traffic data for API scanning has numerous advantages for API issues:
                                        </Text>
                                        {approachItems.map((item, index) => {
                                            return (
                                                <Box key={index}>
                                                    <Text variant='bodySm'> <b>{index + 1}. {item.title}: </b>{item.content}</Text>
                                                </Box>
                                            )
                                        })}
                                    </VerticalStack>
                                </Box>
                            </div>

                            <Divider />
                            <div className="html2pdf__page-break"></div>
                            <div className='report-end-image-container'>
                                <img src="/public/vulnerability_footer.png" alt="Footer Image" className='report-end-image' />
                                <div className='report-end-image-text'>The end.</div>
                            </div>
                        </Box>
                    </div>
                    ) : <SpinnerCentered />}
            </Frame>
        </div>
    )

}

export default VulnerabilityReport;