package com.akto.notifications.slack;

import com.akto.dao.context.Context;
import com.akto.dao.notifications.SlackWebhooksDao;
import com.akto.dto.ApiInfo;
import com.akto.dto.notifications.SlackWebhook;
import com.mongodb.BasicDBList;
import com.mongodb.BasicDBObject;
import com.mongodb.client.model.Projections;

import java.util.ArrayList;
import java.util.List;

import static com.akto.notifications.slack.SlackAlertType.API_TEST_STATUS_ALERT;

public class SsrfVulnerabilityAlert extends SlackAlerts {
    private final String color;
    private List<FieldsModel> fieldsModelList;
    private String dashboardUrl;

    public SsrfVulnerabilityAlert(String testSubType, ApiInfo.ApiInfoKey apiInfoKey, String testRunId, String summaryId, int accountId) {
        super(API_TEST_STATUS_ALERT);
        this.color = "#D72C0D";
        
        // Set account context before querying SlackWebhooksDao (which uses AccountsContextDao)
        // This ensures we query the correct account's Slack webhooks even if context wasn't set by caller
        Context.accountId.set(accountId);
        SlackWebhook slackWebhook = SlackWebhooksDao.instance.findOne(new BasicDBObject(), Projections.include("dashboardUrl"));
        if(slackWebhook != null) {
            dashboardUrl = slackWebhook.getDashboardUrl();
        } else {
            dashboardUrl = "app.akto.io";
        }
        
        init(testSubType, apiInfoKey, testRunId, summaryId);
    }

    private void init(String testSubType, ApiInfo.ApiInfoKey apiInfoKey, String testRunId, String summaryId) {
        fieldsModelList = new ArrayList<>();
        fieldsModelList.add(new FieldsModel("Test Type", "SSRF - " + testSubType));
        fieldsModelList.add(new FieldsModel("Method", apiInfoKey.getMethod().name()));
        fieldsModelList.add(new FieldsModel("URL", apiInfoKey.getUrl()));
        
        String viewUrl = "https://" + dashboardUrl + "/dashboard/testing/" + testRunId + "/results";
        if (summaryId != null && !summaryId.isEmpty()) {
            viewUrl += "?summaryId=" + summaryId;
        }
        fieldsModelList.add(new FieldsModel("View Details", "<" + viewUrl + "|View in Akto>"));
    }

    @Override
    public String toJson() {
        long unixTime = System.currentTimeMillis() / 1000L;
        String dateText = "<!date^" + unixTime + "^{date_pretty} at {time_secs}|Month Date, Year at Time TimeZone>";

        BasicDBList blocksList = new BasicDBList();
        blocksList.add(createHeader("⚠️ SSRF Vulnerability Detected"));
        blocksList.add(createTextContext("A Server-Side Request Forgery (SSRF) vulnerability has been detected in your API."));
        blocksList.add(createFieldSection(fieldsModelList));
        blocksList.add(createTextContext(dateText));

        BasicDBObject blockObj = new BasicDBObject("blocks", blocksList).append("color", color);

        return toAttachment(blockObj).toJson();
    }
}
